# Профайлинг в Go

Инструменты профайлинга в Go:

-   Бенчмарки (go test)
-   Профайлинг в файл (runtime/pprof)
-   Веб-профайлинг (net/http/pprof)

## Бенчмарки

-   Простота использования
-   Не влияет на прод
-   Можно сравнивать бенчмарки
-   Отображают только время исполнения функции целиком

`ns/op` $-$ наносекунда/операция

## pprof

-   Большое количество инструментов для анализа
-   Позволяет анализировать код по частям
-   Запускается из рабочего кода
-   Влияет на производительность
-   Возможность удаленного анализа

Запуск бенчмарка с профилированием:

```bash
go test -bench=<bench_name> -cpuprofile='cpu.prof' -memprofile='mem.prof'
```

Для анализа профиля используется утилита pprof.

```bash
go tool pprof <name>.prof
```

После ввода данной команды откроется "интерпретатор" pprof, с помощью которого можно производить анализ. В этом интерпретаторе можно использовать различные команды для анализа данных:

-   `hide=<package>` $-$ скрывает функции указанной библиотеки;
-   `granularity=lines` $-$ отображает строки, в которых больше всего используются ресурсы;
-   `list <func_name>` $-$ отображает потребление ресурсов построчно;

Например, можно отобразить граф вызовов в вебе с помощью следующей команды:

```bash
go tool pprof -http=":" <name>.prof
```

Чем больше квадрят на графе, тем больше используется CPU.

Сравнение двух профилей CPU:

```bash
go tool pprof -http=:6060 -diff_base cpu_1.prof cpu_2.prof
```

Типы профилирования:

-   CPU (использование процессора приложением);
-   Heap / Memory (использование памяти приложением);
-   Goroutine (функции, создающие наибольшее количество горутин);
-   Block (функции, вызывающие наибольшее количество блокировок);
-   Thread (функции, создающие наибольшее количество потоков);
-   Mutex (функции с наибольшей конкуренцией за мьютексы).
